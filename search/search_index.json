{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Wellcome to Manta","text":"<p>Another CLI tool for Alps.</p> <p>Manta is a frontend CLI to interact and extend CSM, it uses mesa as a backend to interact with the infrastructe (CSM) APIs.</p> <p>Documentation is work in progress</p> <p>This documentation is \"work in progress\" expect changes in the near future</p> <p>Manta's goals:</p> <ul> <li>Release operators from repetitive tasks.</li> <li>Provide quick system feedback.</li> <li>Simplify CICD pipelines</li> </ul> <p>Manta aggregates information from multiple sources:</p> <ul> <li>CSM Keycloak</li> <li>CSM API</li> <li>CSM K8s API</li> <li>local git repo</li> <li>Gitea API (CSM VCS)</li> <li>Hashicorp Vault</li> </ul>"},{"location":"#features","title":"Features","text":"<ul> <li>List and filter CFS configurations based on cluster name or configuration name</li> <li>List and filter CFS sessions based on cluster name or session name</li> <li>List and filter BOS session templates based on cluster name or session name</li> <li>List nodes in HSM groups</li> <li>List hw configuration/components</li> <li>Create CFS configuration and session (target dynamic) from local repository</li> <li>Create CFS configuration and session (target image) from CSCS SAT input file</li> <li>Watch logs of a CFS session</li> <li>Connect to a node's console</li> <li>Power On/Off or restart nodes individually, in a list or per cluster</li> <li>Restrict operations to nodes belonging to a specific HSM group</li> <li>Filter information to a HSM group</li> <li>Update node boot image based on CFS configuration name</li> <li>Audit/Log</li> <li>Delete all data related to CFS configuration</li> <li>Migrate nodes from HSM group based on hw components profile</li> </ul>"},{"location":"#introduction","title":"Introduction","text":"WIP <p>trying to fill the gap in cray and sat CLIs when managing clusters</p>"},{"location":"#configuration-immutability","title":"Configuration immutability","text":"<p>Overwritting configurations used by clusters (nodes booting with an image linked to a configuration or runtime configuration) is a bad practice because the history of that configuration is lost. </p>"},{"location":"#configuration-vs-images","title":"Configuration vs images","text":"<p>Image IDs are typically opaque and do not provide any insight into the content of the image. In other words, you cannot tell what software, configurations, or versions are included in an image just by looking at its ID or name. Due to the obscurity of image IDs, it's crucial to maintain a clear relationship between configurations (the settings and scripts used to create the image) and the images themselves. This means keeping detailed records of which configurations were used to build each image.  Due to the obscurity of image IDs, it's crucial to keep the relationship between configurations and the images themselves. This means keeping the sessions used to create the images and/or configure the nodes. The sessions are important because they are the link between the configurations and the images. They contain the information about which configurations were used to create each image, thus ensuring traceability. </p> <p>Instead of using image IDs directly, the best practice is to refer to the configurations when assigning images to nodes for booting. This ensures that you have a clear understanding of what is being deployed and can replicate or troubleshoot it if necessary.</p>"},{"location":"#cluster-vs-nodes-operations","title":"Cluster vs nodes operations","text":"<p>Provide operations on a list no nodes or on all nodes in a cluster</p>"},{"location":"audit/","title":"Audit","text":"<p>Manta can log user's operations in a local file. The audit file location can be specified in config file with the <code>audit_config</code> field. If missing, then the default location is <code>/var/log/manta/</code> (Linux). Make sure this folder exists and the current user has <code>rwx</code> access to it</p> <pre><code>mkdir /var/log/manta\nchmod 777 -R /var/log/manta\n</code></pre>"},{"location":"basic_operations/","title":"Basic operations","text":"<p>Manta commands have a nomal and a short version</p>"},{"location":"basic_operations/#list-configurations","title":"List configurations","text":"<p>A configuration is a list of layers, each being a git repository containing ansible playbooks, these playbooks will run in order to create an image or to configure nodes during runtime.</p> <p>List/filter the configurations in the system</p> <p>Normal version</p> <pre><code>manta get configurations ...\n</code></pre> <p>Short version</p> <pre><code>manta g c ...\n</code></pre> <p>eg:</p> <p>Get all configurations for cluster 'zinal' which name contains <code>cta_test</code></p> <pre><code>manta g c -H zinal -p '*cta_test*'\n+--------------------------------------------------------------+----------------------+----------------------------------------------------+\n| Config Name                                                  | Last updated         | Layers                                             |\n+==========================================================================================================================================+\n| runtime-zinal_cta_test_hook-mc-cscs-24.3.0.r1-20240602153320 | 2024-06-02T15:33:31Z | Name:     test_layer                               |\n|                                                              |                      | Playbook: site.yml                                 |\n|                                                              |                      | Commit:   abd379d2aeb1d920da33392d610d3012a6ef06a2 |\n|--------------------------------------------------------------+----------------------+----------------------------------------------------|\n| runtime-zinal_cta_test_hook-mc-cscs-24.3.0.r1-20240608192847 | 2024-06-08T19:29:08Z | Name:     test_layer                               |\n|                                                              |                      | Playbook: site.yml                                 |\n|                                                              |                      | Commit:   abd379d2aeb1d920da33392d610d3012a6ef06a2 |\n|--------------------------------------------------------------+----------------------+----------------------------------------------------|\n| runtime-zinal_cta_test_hook-mc-cscs-24.3.0.r1-20240608201045 | 2024-06-08T20:29:28Z | Name:     test_layer                               |\n|                                                              |                      | Playbook: site.yml                                 |\n|                                                              |                      | Commit:   abd379d2aeb1d920da33392d610d3012a6ef06a2 |\n|--------------------------------------------------------------+----------------------+----------------------------------------------------|\n| runtime-zinal_cta_test_hook-mc-cscs-24.3.0.r1-20240608203940 | 2024-06-08T20:39:52Z | Name:     test_layer                               |\n|                                                              |                      | Playbook: site.yml                                 |\n|                                                              |                      | Commit:   abd379d2aeb1d920da33392d610d3012a6ef06a2 |\n+--------------------------------------------------------------+----------------------+----------------------------------------------------+\n</code></pre> <p>Note: the argument <code>-p</code> matches a blob pattern</p> <p>Get last 2 most recent configurations created or updated</p> <pre><code>manta g c -H zinal -l 2\n+--------------------------------------------------------------+----------------------+----------------------------------------------------+\n| Config Name                                                  | Last updated         | Layers                                             |\n+==========================================================================================================================================+\n| runtime-zinal_cta_test_hook-mc-cscs-24.3.0.r1-20240608201045 | 2024-06-08T20:29:28Z | Name:     test_layer                               |\n|                                                              |                      | Playbook: site.yml                                 |\n|                                                              |                      | Commit:   abd379d2aeb1d920da33392d610d3012a6ef06a2 |\n|--------------------------------------------------------------+----------------------+----------------------------------------------------|\n| runtime-zinal_cta_test_hook-mc-cscs-24.3.0.r1-20240608203940 | 2024-06-08T20:39:52Z | Name:     test_layer                               |\n|                                                              |                      | Playbook: site.yml                                 |\n|                                                              |                      | Commit:   abd379d2aeb1d920da33392d610d3012a6ef06a2 |\n+--------------------------------------------------------------+----------------------+----------------------------------------------------+\n</code></pre> <p>If manta realise only one configuration is returned, then it will fetch extra information for each configuration layers, the example below will fetch the details of all configuration layers related to the most recent configuration created across all clusters I have access.</p> <pre><code>manta g c -m\n+--------------------------------------------+----------------------+----------------------------------------------------+--------------------------------------------------------+\n| Configuration Name                         | Last updated         | Layers                                             | Derivatives                                            |\n+=================================================================================================================================================================================+\n| eiger-mc-compute-config-cscs-24.3.0.r1-0.1 | 2024-06-14T17:29:38Z | Name:     csm-packages-1.5.0                       | CFS sessions:                                          |\n|                                            |                      | Branch:   cray/csm/1.16.26                         |  - batcher-3e4e38eb-db3c-45b3-bc00-992ffe4a7792        |\n|                                            |                      | Tag:                                               |  - batcher-b5329f53-8121-49ab-b7dd-7de7f17bf4bb        |\n|                                            |                      | Date:     2024-03-22T10:54:39Z                     |                                                        |\n|                                            |                      | Author:   crayvcs - cf-gitea-import                | BOS sessiontemplates:                                  |\n|                                            |                      | Commit:   6423c550ea38a3b6befc4867ea7319157b48c554 |  - eiger-mc-compute-template-cscs-24.3.0.r1-0.1.x86_64 |\n|                                            |                      | Playbook: csm_packages.yml                         |                                                        |\n|                                            |                      |                                                    | IMS images:                                            |\n|                                            |                      | Name:     shs-cassini_install-cscs-24.3.0          |  - eiger-mc-compute-cscs-24.3.0.r1-0.1                 |\n|                                            |                      | Branch:   cscs-24.3.0cscs-24.5.0                   |                                                        |\n|                                            |                      | Tag:                                               |                                                        |\n|                                            |                      | Date:     2024-05-03T10:24:28+02:00                |                                                        |\n|                                            |                      | Author:   Riccardo Di Maria                        |                                                        |\n|                                            |                      | Commit:   4dead2f7ebd1080d6a65d4b374618cf727624215 |                                                        |\n|                                            |                      | Playbook: shs_cassini_install.yml                  |                                                        |\n|                                            |                      |                                                    |                                                        |\n|                                            |                      | Name:     cos-compute-cscs-24.3.0                  |                                                        |\n|                                            |                      | Branch:   cscs-24.3.0                              |                                                        |\n|                                            |                      | Tag:                                               |                                                        |\n|                                            |                      | Date:     2024-06-14T15:44:11+02:00                |                                                        |\n|                                            |                      | Author:   Gennaro Oliva                            |                                                        |\n|                                            |                      | Commit:   f8247821fa3c220159f31694cc995f24e07bb8f1 |                                                        |\n|                                            |                      | Playbook: cos-compute.yml                          |                                                        |\n|                                            |                      |                                                    |                                                        |\n|                                            |                      | Name:     csm-diags-compute-1.5.26                 |                                                        |\n|                                            |                      | Branch:   cray/csm-diags/1.5.26                    |                                                        |\n|                                            |                      | Tag:                                               |                                                        |\n|                                            |                      | Date:     2024-03-22T17:11:47Z                     |                                                        |\n|                                            |                      | Author:   crayvcs - cf-gitea-import                |                                                        |\n|                                            |                      | Commit:   3b59bd64682b8e55c7f49c6317442b48cea6bb53 |                                                        |\n|                                            |                      | Playbook: csm-diags-compute.yml                    |                                                        |\n|                                            |                      |                                                    |                                                        |\n|                                            |                      | Name:     sma-ldms-compute-1.9.14                  |                                                        |\n|                                            |                      | Branch:   cray/sma/1.9.14                          |                                                        |\n|                                            |                      | Tag:                                               |                                                        |\n|                                            |                      | Date:     2024-03-22T16:24:29Z                     |                                                        |\n|                                            |                      | Author:   crayvcs - cf-gitea-import                |                                                        |\n|                                            |                      | Commit:   09b922e6a608f273dd28dfbc9eaf089b355a56b8 |                                                        |\n|                                            |                      | Playbook: sma-ldms-compute.yml                     |                                                        |\n|                                            |                      |                                                    |                                                        |\n|                                            |                      | Name:     cscs                                     |                                                        |\n|                                            |                      | Branch:   cscs-24.3.0                              |                                                        |\n|                                            |                      | Tag:                                               |                                                        |\n|                                            |                      | Date:     2024-06-14T19:26:31+02:00                |                                                        |\n|                                            |                      | Author:   Gennaro Oliva                            |                                                        |\n|                                            |                      | Commit:   a58fc02eb298cd2b472c616d2ef641ee2c456181 |                                                        |\n|                                            |                      | Playbook: site.yml                                 |                                                        |\n|                                            |                      |                                                    |                                                        |\n|                                            |                      | Name:     cpe-pe_deploy-cscs-24.3.0                |                                                        |\n|                                            |                      | Branch:   cscs-24.5.0                              |                                                        |\n|                                            |                      | Tag:                                               |                                                        |\n|                                            |                      | Date:     2024-06-14T13:51:32+02:00                |                                                        |\n|                                            |                      | Author:   Gennaro Oliva                            |                                                        |\n|                                            |                      | Commit:   f9105c8172af7521910e849d274c91103bfbde75 |                                                        |\n|                                            |                      | Playbook: site-cscs.yml                            |                                                        |\n|                                            |                      |                                                    |                                                        |\n|                                            |                      | Name:     slurm-site-cscs-24.3.0                   |                                                        |\n|                                            |                      | Branch:   cscs-24.3.0                              |                                                        |\n|                                            |                      | Tag:                                               |                                                        |\n|                                            |                      | Date:     2024-06-05T15:58:19+02:00                |                                                        |\n|                                            |                      | Author:   Gennaro Oliva                            |                                                        |\n|                                            |                      | Commit:   e75324a1a35f20fda131fded61a486025fce6d41 |                                                        |\n|                                            |                      | Playbook: site-cscs.yml                            |                                                        |\n|                                            |                      |                                                    |                                                        |\n|                                            |                      | Name:     cos-compute-last-cscs-24.3.0             |                                                        |\n|                                            |                      | Branch:                                            |                                                        |\n|                                            |                      | Tag:                                               |                                                        |\n|                                            |                      | Date:     2024-06-04T18:31:44+02:00                |                                                        |\n|                                            |                      | Author:   Chris Gamboni                            |                                                        |\n|                                            |                      | Commit:   6bf3f82608686da8dbf857656f1e37c4c84054d1 |                                                        |\n|                                            |                      | Playbook: cos-compute-last.yml                     |                                                        |\n+--------------------------------------------+----------------------+----------------------------------------------------+--------------------------------------------------------+\n</code></pre> <p>Note: manta will try to resolve the <code>git tag</code> related to each <code>configuration layer</code></p>"},{"location":"basic_operations/#list-sessions","title":"List sessions","text":"<p>A session is a job against a configuration to create an image or configure a compute node during runtime.</p> <p>List/filter the sessions in the system</p> <p>Normal version</p> <pre><code>manta get sessions ...\n</code></pre> <p>Short version</p> <pre><code>manta g s ...\n</code></pre> <p>eg:</p> <p>Get all configurations for cluster 'eiger'</p> <p><pre><code>manta get sessions -H eiger\n+----------------------------------------------+--------------------------------------------+---------------------+----------+-----------+------------+---------------+----------+\n| Session Name                                 | Configuration Name                         | Start               | Status   | Succeeded | Target Def | Target        | Image ID |\n+================================================================================================================================================================================+\n| batcher-3e4e38eb-db3c-45b3-bc00-992ffe4a7792 | eiger-mc-compute-config-cscs-24.3.0.r1-0.1 | 2024-06-15T14:28:58 | complete | true      | dynamic    | x1000c0s0b1n0 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s0b0n0 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s0b0n1 |          |\n|----------------------------------------------+--------------------------------------------+---------------------+----------+-----------+------------+---------------+----------|\n| batcher-b5329f53-8121-49ab-b7dd-7de7f17bf4bb | eiger-mc-compute-config-cscs-24.3.0.r1-0.1 | 2024-06-15T14:29:00 | complete | true      | dynamic    | x1000c0s3b1n1 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s3b0n0 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s3b1n0 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s1b0n1 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s1b1n0 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s0b1n1 |          |\n|                                              |                                            |                     |          |           |            | x1002c0s7b0n0 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s2b0n1 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s2b0n0 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s1b1n1 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s1b0n0 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s2b1n1 |          |\n|                                              |                                            |                     |          |           |            | x1000c0s3b0n1 |          |\n+----------------------------------------------+--------------------------------------------+---------------------+----------+-----------+------------+---------------+----------+\n</code></pre> eg</p> <p>Get last 3 sessions created among all the clusters the user has access</p> <pre><code>manta get sessions -l 3\n+----------------------------------------------+--------------------------------------------+---------------------+----------+-----------+------------+----------------+----------+\n| Session Name                                 | Configuration Name                         | Start               | Status   | Succeeded | Target Def | Target         | Image ID |\n+=================================================================================================================================================================================+\n| batcher-3f4da728-2160-45d2-9109-26313eb1ae1b | adula-uan-config-24.5.0-2                  | 2024-06-15T14:29:00 | complete | false     | dynamic    | x3100c0s28b0n0 |          |\n|----------------------------------------------+--------------------------------------------+---------------------+----------+-----------+------------+----------------+----------|\n| batcher-b5329f53-8121-49ab-b7dd-7de7f17bf4bb | eiger-mc-compute-config-cscs-24.3.0.r1-0.1 | 2024-06-15T14:29:00 | complete | true      | dynamic    | x1000c0s3b1n1  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s3b0n0  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s3b1n0  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s1b0n1  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s1b1n0  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s0b1n1  |          |\n|                                              |                                            |                     |          |           |            | x1002c0s7b0n0  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s2b0n1  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s2b0n0  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s1b1n1  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s1b0n0  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s2b1n1  |          |\n|                                              |                                            |                     |          |           |            | x1000c0s3b0n1  |          |\n|----------------------------------------------+--------------------------------------------+---------------------+----------+-----------+------------+----------------+----------|\n| batcher-9dfea67f-6638-4acf-8429-4d242e264bdb | adula-uan-config-24.5.0-2                  | 2024-06-15T14:46:51 | complete | false     | dynamic    | x3100c0s28b0n0 |          |\n+----------------------------------------------+--------------------------------------------+---------------------+----------+-----------+------------+----------------+----------+\n</code></pre>"},{"location":"basic_operations/#list-images","title":"List images","text":"<p>Images are created through sessions against configurations. Images can be assigned to nodes to boot. Manta tracks down the configuration used to build an image through the sessions used to build it, withtout this information the image content is not traceable and the nodes using it are subject to errors or misconfiguration.</p> <p>List/filter the images in the system</p> <p>Normal version</p> <pre><code>manta get images ...\n</code></pre> <p>Short version</p> <pre><code>manta g i ...\n</code></pre> <p>eg</p> <p>List images all images created for cluster eiger</p> <pre><code>manta g i -H eiger\n+--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------+\n| Image ID                             | Name                                | Creation time                    | CFS configuration | HSM groups |\n+================================================================================================================================================+\n| 39c7603b-805b-4aeb-9c4b-27f960400489 | eiger-uan-3.1.0                     | 2023-03-31T08:52:39.210677+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| 44d34cf9-01d1-4600-bbf3-a69b303bf464 | eiger-cos-3.1.0                     | 2023-03-31T08:53:43.665937+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| 5024e45e-d1f5-4cca-bf7b-0b0b4e7f0785 | eiger-uan-3.1.1                     | 2023-06-13T11:03:21.448332+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| 5e7c2e99-7386-4db5-b39b-6e5f107936bd | eiger-cos-3.1.1                     | 2023-06-13T11:03:51.481619+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| cbaf89c5-d5be-4251-b154-c81b05bd5e59 | eiger-uan-3.1.2                     | 2023-10-19T19:09:42.689921+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| 09b986aa-2ee1-44a2-8358-71d11a772f5f | eiger-cos-3.1.2                     | 2023-10-19T19:10:04.608446+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| 83f0224d-e1db-4925-8de6-55cdf0b3bbf1 | eiger-uan-3.1.4                     | 2023-11-22T14:51:39.867557+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| a279cfc0-88db-48db-af18-b044326d4d9e | eiger-cos-3.1.4                     | 2023-11-22T14:52:41.057211+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| 866dc945-f7e7-475f-9ce2-b8480bc070d6 | eiger-uan-3.1.6                     | 2024-02-28T08:55:05.596347+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| 3cd22417-0a13-4e55-afd1-645ebfd00805 | eiger-cos-3.1.6                     | 2024-02-28T08:55:19.685122+00:00 | Not found         |            |\n|--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------|\n| 9503d311-91a1-40bc-a484-0ea18a9167e7 | eiger-mc-compute-cscs-24.3.0.r1-0.1 | 2024-06-05T15:10:54.924288+00:00 | Not found         |            |\n+--------------------------------------+-------------------------------------+----------------------------------+-------------------+------------+\n</code></pre>"},{"location":"basic_operations/#list-cluster-detailssummary","title":"List cluster details/summary","text":""},{"location":"basic_operations/#list-hardware-information","title":"List hardware information","text":"<p>List the hardware information in the system</p> <p>Normal version</p> <pre><code>manta get hardware cluster ...\nmanta get hardware node ...\n</code></pre> <p>Short version</p> <p><pre><code>manta g hw c ...\nmanta g hw n ...\n</code></pre> eg</p> <p>Get hardware components summary for cluster eiger</p> <pre><code>manta g hw cluster eiger\nGetting hw components for node 'x1002c0s7b0n0' [16/17]\n+------------------------------------+----------+\n| HW Component                       | Quantity |\n+===============================================+\n| Memory (GiB)                       | 4608     |\n|------------------------------------+----------|\n| SS11 200Gb 2P NIC Mezz REV02 (HSN) | 17       |\n|------------------------------------+----------|\n| AMD EPYC 7742 64-Core Processor    | 34       |\n+------------------------------------+----------+\n</code></pre> <p>eg</p> <p>Get hardware component details for cluster eiger</p> <pre><code>manta g hw cluster eiger --output details\nGetting hw components for node 'x1002c0s7b0n0' [16/17]\n+---------------+-----------+-----------+---------------------------------+------------------------------------+\n| Node          | 16384 MiB | 32768 MiB | AMD EPYC 7742 64-Core Processor | SS11 200Gb 2P NIC Mezz REV02 (HSN) |\n+==============================================================================================================+\n| x1000c0s0b0n0 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s0b0n1 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s0b1n0 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s0b1n1 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s1b0n0 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s1b0n1 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s1b1n0 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s1b1n1 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s2b0n0 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s2b0n1 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s2b1n0 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s2b1n1 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s3b0n0 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s3b0n1 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s3b1n0 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1000c0s3b1n1 |  \u2705 (16)  |     \u274c    |              \u2705 (2)             |               \u2705 (1)               |\n|---------------+-----------+-----------+---------------------------------+------------------------------------|\n| x1002c0s7b0n0 |     \u274c    |  \u2705 (16)  |              \u2705 (2)             |               \u2705 (1)               |\n+---------------+-----------+-----------+---------------------------------+------------------------------------+\n</code></pre>"},{"location":"basic_operations/#get-session-logs","title":"Get session logs","text":"<p>It is possible to inspect the ansible output when a session is running.</p> <p>Normal version</p> <pre><code>manta get log ...\n</code></pre> <p>Short version</p> <pre><code>manta l ...\n</code></pre> <p>eg</p> <p>Get the logs of a session</p> <pre><code>manta log --session-name batcher-cef892ee-39af-444a-b32c-89478a100e4d\n[2022-09-27T12:41:49Z INFO  manta::shasta_cfs_session_logs::client] Pod name: \"cfs-b49cdc2b-d6cb-4477-b502-6be479472546-2jrlg\"\nWaiting for Inventory\nWaiting for Inventory\nWaiting for Inventory\nWaiting for Inventory\nWaiting for Inventory\nWaiting for Inventory\nWaiting for Inventory\nInventory generation completed\nSSH keys migrated to /root/.ssh\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\nHTTP/1.1 200 OK\ncontent-type: text/html; charset=UTF-8\ncache-control: no-cache, max-age=0\nx-content-type-options: nosniff\ndate: Tue, 27 Sep 2022 12:18:16 GMT\nserver: envoy\ntransfer-encoding: chunked\n\nSidecar available\n[WARNING]: Invalid characters were found in group names but not replaced, use\n-vvvv to see details\n\nPLAY [Compute] *****************************************************************\n\nPLAY [Application] *************************************************************\nskipping: no hosts matched\n\nPLAY [Management_Worker] *******************************************************\nskipping: no hosts matched\n\nPLAY RECAP *********************************************************************\nx1500c7s2b0n0              : ok=1    changed=0    unreachable=0    failed=0    skipped=33   rescued=0    ignored=0\n</code></pre>"},{"location":"basic_operations/#connect-to-node-console","title":"Connect to node console","text":"<p>Sometimes, the node is unrecheable or can't be accessed, for these cases, the console may help to diagnose hardware issues.</p> <p>eg</p> <pre><code>manta console x1500c2s4b0n1\nConnected to x1500c2s4b0n1!\nUse &amp;. key combination to exit the console.\n\n&lt;ConMan&gt; Connection to console [x1500c2s4b0n1] opened.\n\n&lt;ConMan&gt; Console [x1500c2s4b0n1] joined with &lt;nobody@localhost&gt; on pts/511 at 10-30 02:14.\n\nnid003129 login:\n</code></pre>"},{"location":"basic_operations/#power-management","title":"Power management","text":""},{"location":"basic_operations/#power-on-cluster","title":"Power on cluster","text":"<p>Normal version</p> <pre><code>manta power on cluster &lt;cluster name&gt;\n</code></pre> <p>Short version</p> <pre><code>manta p on c &lt;cluster name&gt;\n</code></pre> <p>eg:</p> <p>Power on cluster <code>zinal</code></p> <pre><code>manta p on c zinal\n</code></pre>"},{"location":"basic_operations/#power-on-nodes","title":"Power on nodes","text":"<p>Normal version</p> <pre><code>manta power on nodes &lt;list of nodes&gt;\n</code></pre> <p>Short version</p> <pre><code>manta p on n &lt;list of nodes&gt;\n</code></pre> <p>eg:</p> <p>Power on a list of nodes</p> <pre><code>manta p on n x1001c1s5b0n0,x1001c1s5b0n1\n</code></pre>"},{"location":"basic_operations/#power-off-cluster","title":"Power off cluster","text":"<p>Normal version</p> <pre><code>manta power off cluster &lt;cluster name&gt;\n</code></pre> <p>Short version</p> <pre><code>manta p off c &lt;cluster name&gt;\n</code></pre> <p>eg:</p> <p>Power off cluster <code>zinal</code></p> <pre><code>manta p off c zinal\n</code></pre>"},{"location":"basic_operations/#power-off-nodes","title":"Power off nodes","text":"<p>Normal version</p> <pre><code>manta power off nodes &lt;list of nodes&gt;\n</code></pre> <p>Short version</p> <pre><code>manta p off n &lt;list of nodes&gt;\n</code></pre> <p>eg:</p> <p>Power off a list of nodes</p> <pre><code>manta p off n x1001c1s5b0n0,x1001c1s5b0n1\n</code></pre>"},{"location":"basic_operations/#power-reset-cluster","title":"Power reset cluster","text":"<p>Normal version</p> <pre><code>manta power reset cluster &lt;cluster name&gt;\n</code></pre> <p>Short version</p> <pre><code>manta p reset c &lt;cluster name&gt;\n</code></pre> <p>eg:</p> <p>Power reset cluster <code>zinal</code></p> <pre><code>manta p reset c zinal\n</code></pre>"},{"location":"basic_operations/#power-reset-nodes","title":"Power reset nodes","text":"<p>Normal version</p> <pre><code>manta power reset nodes &lt;list of nodes&gt;\n</code></pre> <p>Short version</p> <pre><code>manta p reset n &lt;list of nodes&gt;\n</code></pre> <p>eg:</p> <p>Power reset a list of nodes</p> <pre><code>manta p reset n x1001c1s5b0n0,x1001c1s5b0n1\n</code></pre>"},{"location":"basic_operations/#set-runtime-configuration","title":"Set runtime configuration","text":"<p>Normal version</p> <pre><code>manta set runtime-configuration ...\n</code></pre> <p>Short version</p> <pre><code>manta s rc ...\n</code></pre> <p>eg:</p> <p>Set/update runtime configuration for all nodes in a cluster</p> <pre><code>manta set runtime-configuration --hsm-group zinal --configuration my_configuration\n</code></pre> <p>Set/update runtime configuration for a list of nodes</p> <pre><code>manta set runtime-configuration --xnames x1001c1s5b0n0,x1001c1s5b0n1 --configuration my_configuration\n</code></pre>"},{"location":"basic_operations/#set-boot-image","title":"Set boot image","text":"Highly discourage <p>Use this command only if <code>manta set boot-configuration</code> fails because it can't find the sessions linking the configuration with the image (meaning information in the system has been deleted)</p> <p>Normal version</p> <pre><code>manta set boot-image ...\n</code></pre> <p>Short version</p> <pre><code>manta s bi ...\n</code></pre> <p>eg:</p> <p>Set/update boot image for all nodes in a cluster</p> <pre><code>manta set boot-image --hsm-group zinal --image-id e2ce82f0-e7ba-4f36-9f5c-750346599600\n</code></pre> <p>Set/update runtime configuration for a list of nodes</p> <pre><code>manta set boot-image --xnames x1001c1s5b0n0,x1001c1s5b0n1 --image-id e2ce82f0-e7ba-4f36-9f5c-750346599600\n</code></pre>"},{"location":"basic_operations/#set-boot-configuration","title":"Set boot configuration","text":"<p>Normal version</p> <pre><code>manta set boot-configuration ...\n</code></pre> <p>Short version</p> <pre><code>manta s bc ...\n</code></pre> <p>eg:</p> <p>Set/update boot configuration for all nodes in a cluster</p> <pre><code>manta set boot-configuration --hsm-group zinal --configuration my-configuration\n</code></pre> <p>Set/update boot configuration for a list of nodes</p> <pre><code>manta set boot-configuration --xnames x1001c1s5b0n0,x1001c1s5b0n1 --configuration my-configuration\n</code></pre>"},{"location":"basic_operations/#set-kernel-parameters","title":"Set kernel parameters","text":"Do not use <code>rootfs</code> <p>The <code>rootfs</code> kernel parameter is managed automatically when changing the boot image, do not add <code>rootfs</code> kernel param in this command</p> <p>Normal version</p> <pre><code>manta set kernel-parameters ...\n</code></pre> <p>Short version</p> <pre><code>manta s kp ...\n</code></pre> <p>eg:</p> <p>Set/update boot configuration for all nodes in a cluster</p> <pre><code>manta set kernel-parameters --hsm-group zinal --kernel-parameters \"console=ttyS0,115200 bad_page=panic crashkernel=512M hugepagelist=2m-2g intel_pstate=disable iommu.passthrough=on numa_balancing=disable numa_interleave_omit=headless oops=panic pageblock_order=14 pcie_ports=native rd.retry=10 rd.shell split_lock_detect=off systemd.unified_cgroup_hierarchy=1 ip=dhcp quiet ksocklnd.skip_mr_route_setup=1 cxi_core.disable_default_svc=0 cxi_core.enable_fgfc=1 cxi_core.sct_pid_mask=0xf spire_join_token=${SPIRE_JOIN_TOKEN}\"\n</code></pre> <p>Set/update boot configuration for a list of nodes</p> <pre><code>manta set kernel-parameters --xnames x1001c1s5b0n0,x1001c1s5b0n1 --kernel-parameters \"console=ttyS0,115200 bad_page=panic crashkernel=512M hugepagelist=2m-2g intel_pstate=disable iommu.passthrough=on numa_balancing=disable numa_interleave_omit=headless oops=panic pageblock_order=14 pcie_ports=native rd.retry=10 rd.shell split_lock_detect=off systemd.unified_cgroup_hierarchy=1 ip=dhcp quiet ksocklnd.skip_mr_route_setup=1 cxi_core.disable_default_svc=0 cxi_core.enable_fgfc=1 cxi_core.sct_pid_mask=0xf spire_join_token=${SPIRE_JOIN_TOKEN}\n</code></pre>"},{"location":"basic_operations/#migrate-nodes-across-clusters","title":"Migrate nodes across clusters","text":"<p>Move a list of nodes from one cluster to another</p> <p>Normal version</p> <pre><code>manta migrate nodes ...\n</code></pre> <p>Short version</p> <pre><code>manta m n ...\n</code></pre> <p>eg:</p> <p>Move node 'x1001c1s7b0n0' from cluster 'zinal_cta' to cluster 'zinal_tds'</p> <pre><code>manta m n -d -f zinal_cta -t zinal_tds x1001c1s7b0n0`\nHSM 'zinal_tds' members: [\"x1001c1s7b0n0\", \"x1001c1s7b0n1\"]\nHSM 'zinal_cta' members: []\n</code></pre>"},{"location":"cluster_mgmt_with_sat_file/","title":"Cluster management with SAT file","text":"<p>The sat file is used by the <code>sat bootprep</code> command to create configurations, images and configure/deploy clusters. The entry points are 2 files, one used as a template and another with the values.</p> <p>Manta is compatible and extends the <code>sat bootprep</code> file features.</p>"},{"location":"cluster_mgmt_with_sat_file/#sat-files-cannot-have-configurations-only","title":"SAT files cannot have configurations only","text":"<p>Currently, the management plane does not track which cluster belongs to which configuration unless there is an <code>image</code> or a <code>session template</code> linked to it. The reason is <code>images</code> and <code>session templates</code> are linked to both configurations and nodes or clusters, therefore we need to list those in order to be able which cluster is using which configuration and be able to find out if it is relevant to the user. Due to this behaviour, manta won't process SAT files with only configurations unless they are esplicitly used in a <code>image</code> or a <code>session template</code>.</p>"},{"location":"cluster_mgmt_with_sat_file/#the-example-below-wont-work","title":"The example below won't work","text":"<pre><code>cat my_sat_template.yml\n---\nconfigurations:\n- name: \"my-configuration\"\n  layers:\n  - name: test_layer\n    playbook: site.yml\n    git:\n      url: https://api-gw-service-nmn.local/vcs/cray/test_layer.git\n      tag: 1.0  # Using git tags\n</code></pre> <p>The file neither has a <code>image</code> nor a <code>session_template</code> section, therefore there is no way for manta to track which cluster this configuration belongs to or which user has access to it.</p>"},{"location":"cluster_mgmt_with_sat_file/#the-example-below-is-correct","title":"The example below is correct","text":"<pre><code>cat my_sat_template.yml\n---\nschema_version: 1.0.2\nconfigurations:\n- name: \"runtime-{{vcluster.name}}-mc-{{default.suffix}}-{{vcluster.version}}\"\n  layers:\n  - name: test_layer\n    playbook: site.yml\n    git:\n      url: https://api-gw-service-nmn.local/vcs/cray/test_layer.git\n      tag: {{test_layer.tag}}\n\nsession_templates:\n- name: \"{{vcluster.name}}-mc-{{default.suffix}}-{{vcluster.version}}.x86_64\"\n  ims:\n    id: dbc5300c-3c98-4384-a7a7-28e628cbff43\n  configuration: \"runtime-{{vcluster.name}}-mc-{{default.suffix}}-{{vcluster.version}}\"\n  bos_parameters:\n    boot_sets:\n      compute:\n        arch: X86\n        kernel_parameters: ip=dhcp quiet ksocklnd.skip_mr_route_setup=1 cxi_core.disable_default_svc=0 cxi_core.enable_fgfc=1 cxi_core.sct_pid_mask=0xf spire_join_token=${SPIRE_JOIN_TOKEN}\n        node_groups:\n          {{ vcluster.sessiontemplate_group_list }}\n        rootfs_provider_passthrough: \"dvs:api-gw-service-nmn.local:300:hsn0,nmn0:0\"\n</code></pre>"},{"location":"cluster_mgmt_with_sat_file/#extra-features","title":"Extra features","text":""},{"location":"cluster_mgmt_with_sat_file/#jinja2-template-engine","title":"jinja2 template engine","text":"<p>While sat bootprep templating seems very simple, manta follows ansible approach and uses a jinja2 template engine.</p> Using <code>-</code> in variable names is not recommended <p>A common mistake when dealing with jinja2 files is using <code>-</code> in variable names. This won't work since jinja will expand this as a math operator, to avoid this issue, try to use <code>_</code> instead.</p> <p>eg:</p> <p>When a jinja template engine sees this <code>{{ template-version }}</code> it will try to resolve <code>template-version</code> as a mathematical expression (substract) of 2 variables (variable <code>template</code> and variable <code>version</code>). If those variables don't exists in the sessions var, then they will become <code>undefined</code> and the jinja template engine will try to substract the 2 undefined values <code>undefined - undefine</code>, then, the operation will fail. This however would work if the session vars contains:</p> <pre><code>$ cat my_sat_vars.yml\ntemplate: 4\nversion: 3\n</code></pre> <p>And as a result, the session template name would become <code>my_template_1</code> as a result of <code>4 - 3 = 1</code></p>"},{"location":"cluster_mgmt_with_sat_file/#the-example-below-will-fail","title":"The example below will fail","text":"<p>template file:</p> <pre><code>cat my_sat_template.yml\n---\nschema_version: 1.0.2\nconfigurations:\n- name: \"my_config\"\n  layers:\n  - name: test_layer\n    playbook: site.yml\n    git:\n      url: https://api-gw-service-nmn.local/vcs/cray/test_layer.git\n      tag: v0.1.0\n\nsession_templates:\n- name: \"my-template-{{ template-version }}\" # Won't work. Error when resolving `session-version` because `-` is a math operator. Don't use `-` in variable names\n  ims:\n    id: dbc5300c-3c98-4384-a7a7-28e628cbff43\n  configuration: \"runtime_my_config_mc\"\n  bos_parameters:\n    boot_sets:\n      compute:\n        arch: X86\n        kernel_parameters: ip=dhcp quiet ksocklnd.skip_mr_route_setup=1 cxi_core.disable_default_svc=0 cxi_core.enable_fgfc=1 cxi_core.sct_pid_mask=0xf spire_join_token=${SPIRE_JOIN_TOKEN}\n        node_groups:\n          - fora\n        rootfs_provider_passthrough: \"dvs:api-gw-service-nmn.local:300:hsn0,nmn0:0\"\n</code></pre> <p>var session file</p> <pre><code>cat my_sat_vars.yml\n---\nsession-version: 1.0 # Won't work. Variable names should not have `-`\n</code></pre> <p>And the error will be very explicit</p> <pre><code>manta a sat -t my_sat_template.yml -f my_sat_vars.yml\n...\ncalled `Result::unwrap()` on an `Err` value: Error { kind: InvalidOperation, detail: \"tried to use - operator on unsupported types undefined and undefined\", name: \"&lt;string&gt;\", line: 13 }\n\n---------------------------------- &lt;string&gt; -----------------------------------\n  10 |       tag: {{test_layer.tag}}\n  11 |\n  12 | session_templates:\n  13 &gt; - name: \"my-template-{{ template-version }}\" # Won't work. Error when resolving `session-version` because `-` is a math operator. Don't use `-` in variable names\n     i                         ^^^^^^^^^^^^^^^^ invalid operation\n  14 |   ims:\n  15 |     id: dbc5300c-3c98-4384-a7a7-28e628cbff43\n  16 |   configuration: \"runtime_my_config_mc\"\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n...\n</code></pre>"},{"location":"cluster_mgmt_with_sat_file/#the-example-below-is-correct_1","title":"The example below is correct","text":"<p>template file:</p> <pre><code>session_templates:\n- name: \"my_template_{{ template_version }}\"\n  ims:\n    id: dbc5300c-3c98-4384-a7a7-28e628cbff43\n  configuration: \"runtime_my_config_mc\"\n...\n</code></pre> <p>var session file</p> <pre><code>session_version: 1.0\n...\n</code></pre>"},{"location":"cluster_mgmt_with_sat_file/#git-tags-in-configuration-layers","title":"Git tags in configuration layers","text":"<p>Manta can resolve git tags in configuration layers</p> <pre><code>---\nconfigurations:\n- name: \"my-configuration\"\n  layers:\n  - name: test_layer\n    playbook: site.yml\n    git:\n      url: https://api-gw-service-nmn.local/vcs/cray/test_layer.git\n      tag: 1.0  # manta will resolve this git tag for this repo and replace this line with `commit: &lt;commit id/SHA&gt;`\n...\n</code></pre> <p>In the example above, we are telling manta we want Alps to use the ansible in repo <code>test_layer</code> based on git tag <code>1.0</code>. As a consequence, Manta will resolve the git tag to its commit id, set this value in the sat file configuration layer and submit the configuration craetion task to Alps management plane.</p>"},{"location":"cluster_mgmt_with_sat_file/#expand-sat-template-file-variables-with-cli-arguments","title":"Expand SAT template file variables with CLI arguments","text":"<p>Manta can expand the variables in the template file with a vars file or through CLI. Users can submit values in both vars file and as CLI arguments, if a variable value exists in both (vars file and as a CLI argument) then the CLI argument will take preference and overwrite the value in the vars file.</p> <p>eg</p> <p>Submit a sat file without the vars file, the sat template file only has 1 variable <code>version</code> which value is sent through CLI argument</p> <pre><code>manta a sat -t my_sat_file.yml -v \"version=v1.2.0\"\n</code></pre> <p>eg</p> <p>This second example shows an example where a user submits 2 different values for the <code>version</code> variable. CLI arguments take preference and the final value for the <code>version</code> variable is <code>v1.2.0</code>.</p> <pre><code>cat my_sat_vars.yml\nversion: 0.0.5\n\nmanta a sat -t my_sat_file.yml -f my_sat_vars.yaml -v \"version=v1.2.0\"\n</code></pre>"},{"location":"cluster_mgmt_with_sat_file/#the-__date__-wildcard","title":"the <code>__DATE__</code> wildcard","text":"<p>Since configurations are immutable in manta, having to change the vars file to update the version may be painful to deal with (specially during development), if this is the case, then manta has a special wildcard <code>__DATE__</code> to simplify this process.</p> <p>eg</p> <p>Having the vars and template files below</p> <pre><code>cat my_sat_vars.yml\nversion: __DATE__\n</code></pre> <pre><code>cat my_sat_file.yml\n---\nconfigurations:\n- name: \"my-configuration-{{ version }}\"\n...\n</code></pre> <p>The vars file use the <code>__DATE__</code> wildcard to substitute the version variable with current timestame everytime <code>manta a sat</code> runs, the configuration name will resolve to something like <code>my-configuration-20240608201045</code> this forces to have a different configuration name every time <code>manta a sat</code> runs</p> <p>This is only recommended during development or test/dev clusters</p> <p>\"In production, the user of <code>__DATE__</code> is discarded and a proper version name should be used instead\"</p>"},{"location":"cluster_migration/","title":"Cluster migration","text":"WIP <p>This is work in progress</p> <p>Operations to migrate clusters. Cluster migration includes operations like:</p> <ul> <li>Upscale hardware resources</li> <li>Downscale hardware resources</li> <li>Move compute nodes and configure them across different sites</li> </ul>"},{"location":"configuration/","title":"Create a configuration file","text":""},{"location":"configuration/#configuration","title":"Configuration","text":"<p>By default, Manta follows the XDG Base Directory Specification (folder mapping per OS) to find files. The configuration file needs to be under <code>$XDG_CONFIG_HOME/manta/</code> folder.</p> <p>By default, Manta configuration file can be found under one of the following locations:</p> <ul> <li>Linux: $HOME/.config/manta/config.toml</li> <li>MacOS: $HOME/Library/Application Support/manta/config.toml</li> </ul> <pre><code>mkdir -p /home/msopena/.config/manta\n\ncat &gt;&gt; ~/.config/manta/config.toml &lt;&lt;EOF\nlog = \"info\"\n\nsite = \"alps\"\n\n[sites]\n\n[sites.alps]\nsocks5_proxy = \"socks5h://127.0.0.1:1080\"\nshasta_base_url = \"https://api.cmn.alps.cscs.ch\"\nk8s_api_url = \"https://10.252.1.12:6442\"\nvault_base_url = \"https://hashicorp-vault.cscs.ch:8200\"\nvault_secret_path = \"shasta\"\nvault_role_id = \"b15517de-cabb-06ba-af98-633d216c6d99\" # vault in hashicorp-vault.cscs.ch\nroot_ca_cert_file = \"alps_root_cert.pem\"\nEOF\n</code></pre> <p>Alternatively, an environment variable could be used to tell Manta where to find the configuration file <code>MANTA_CONFIG=/home/msopena/my_config.toml manta config show</code></p>"},{"location":"configuration/#legend","title":"Legend:","text":"Name mandatory Type Description Example MANTA_CONFIG no env path to manta configuration file. If missing, then <code>$XDG_CONFIG/manta/confog.toml</code> will be used $HOME/my_confog.toml MANTA_CSM_TOKEN no env CSM authentication token, if this env var is missing, then manta will prompt use for credentials against CSM keycloak log no config file log details/verbosity off/error/warn/info/debug/trace hsm_group no config If exists, then it will filter/restrict the hsm groups and/or xnames targeted by the cli command psi-dev site yes config file CSM instance manta comunicates with. Requires to have the right site in the \"sites\" section alps sites.site_name.socks5_proxy yes config file socks proxy to access the services (only needed if using manta from outside a Shasta management node. Need VPN. Need to ope your VPN IP in hashicorp  vault approle) socks5h://127.0.0.1:1080 sites.site_name.k8s_api_url yes config file Shasta k8s API URL https://10.252.1.12:6442 sites.site_name.vault_base_url yes config file Hashicorp Vault base URL storing secrets to authenticate to external services https://hashicorp-vault.cscs.ch sites.site_name.vault_role_id yes config file role id related to Hashicorp Vault base URL approle authentication b15517de-cabb-06ba-af98-633d216c6d99 sites.site_name.vault_secret_path yes config file path in vault to find secrets shasta sites.site_name.shasta_base_url yes config file Shasta API base URL for Shasta related jobs submission https://api-gw-service-nmn.local/apis root_ca_cert_file yes config file file name with the CSM root CA. This certificate is used to trust the CSM server alps_root_cert.pem config_file no config file path to audit file location $HOME/audit_file.log"},{"location":"configuration/#add-csm-root-certificate-token","title":"Add CSM root certificate token","text":"<p>To configure Manta, you need the CSM CA public root certificate. Please request this certificate from your CSM system administrator. Once you have the certificate file, place it in the same directory as the Manta configuration file. Ensure that the file name matches the value specified for <code>root_ca_cert_file</code> in the configuration file (e.g., <code>alps_root_cert.pem</code>)</p>"},{"location":"configuration/#manage-multiple-sites","title":"Manage multiple sites","text":"<p>From Manta's perspective, each site functions as an independent CSM instance. To enable Manta to communicate with different geographically distributed HPE Cray Ex systems, you need to replicate the [site.] section in the configuration file with the correct values for each site."},{"location":"configuration/#test","title":"Test","text":"<p>Run the command below to test manta installation/configuration</p> <pre><code>$ manta --help\nUsage: manta [COMMAND]\n\nCommands:\n  power                Command to submit commands related to cluster/node power management\n  get                  Get information from Shasta system\n  add                  WIP - Add hw components to cluster\n  remove               WIP - Remove hw components from cluster\n  apply                Make changes to Shasta system\n  migrate              WIP - Migrate vCluster\n  update               Update nodes power status or boot params\n  log                  get cfs session logs\n  console              Opens an interective session to a node or CFS session ansible target\n                           container\n  delete               Deletes CFS configurations, CFS sessions, BOS sessiontemplates, BOS\n                           sessions and images related to CFS configuration/s.\n  validate-local-repo  Check all tags and HEAD information related to a local repo exists in\n                           Gitea\n  config               Manta's configuration\n  help                 Print this message or the help of the given subcommand(s)\n\nOptions:\n  -h, --help     Print help\n  -V, --version  Print version\n</code></pre> <p>To test manta undertands your configuration file</p> <p>The output of the command below may be different than yours, this is normal since manta can deal with different systems/clusters</p> <pre><code>$ manta config show\nSites: [\"alps\", \"prealps\", \"alpsm\"]\nCurrent site: alps\nHSM available: [\"adula\", \"alps\", \"burst\", \"burst_gh\", \"burst_mc\", \"eiger\", \"fora\", \"nodes_free\", \"psidev\", \"psidev_cn\", \"psidev_uan\", \"psitds\", \"psitds_cn\", \"psitds_uan\", \"zinal\", \"zinal_cta\", \"zinal_moleson_tds\", \"zinal_tds\", \"zinal_zinal\"]\nCurrent HSM:\nParent HSM: nodes_free\n</code></pre>"},{"location":"faq/","title":"FAQ","text":"<p>What should we put here?</p> <ul> <li>List most common questions when using manta (eg: like a howto guide)</li> <li>Don't put errors here</li> </ul> <p>Q: Can I run manta from my laptop?</p> <p>A: Depends. Alps system management APIs are not accessible from the public network.</p> <ul> <li> <p>External users need to run manta from a hardened environment within CSCS.</p> </li> <li> <p>CSCS staff can create a SOCKS5 proxy through bastion and run manta from outside CSCS.</p> </li> </ul> <p>Q: <code>manta get ...</code> only shows information for 1 cluster, I am missing other clusters data</p> <p>A: make sure manta is not locked to a cluster, run <code>manta config show</code> and make sure there is no <code>Current HSM</code> value.</p> <p>In this example: <pre><code>$ manta config show\nSites: [\"prealps\", \"alps\", \"alpsm\"]\nCurrent site: alps\nHSM available: [\"adula\", \"alps\", \"burst\", \"burst_gh\", \"burst_mc\", \"eiger\", \"fora\", \"nodes_free\", \"psidev\", \"psidev_cn\", \"psidev_uan\", \"psitds\", \"psitds_cn\", \"psitds_uan\", \"zinal\", \"zinal_cta\", \"zinal_moleson_tds\", \"zinal_tds\", \"zinal_zinal\"]\nCurrent HSM: adula\nParent HSM: nodes_free\n</code></pre> manta is locked to cluster <code>adula</code>, therefore it will ignore other cluster's information, to remove this property run command <code>manta config unset hsm</code></p> <p>Q: I have been given access to a new cluster, however I can't see it.</p> <p>A: The user authentication token keeps the number of clusters the user has access to. Any changes related to the user access needs a token refresh. To do this run the following commands:</p> <p>Delete token for the site hosting the cluster the user needs access to</p> <pre><code>$ manta config unset auth\nPlease chose the site token to delete from the list below:\n&gt; prealps_auth\n  alps_auth\n</code></pre> <p>Select the site which auth token needs to be deleted (eg prealps_auth)</p> <p>Manta will ask the user to authenticate upon the next operation against <code>prealps</code>, if authentication is successful, then the user should receive a new token with the new list of cluster he has access to this site/system</p> <p>Q: My sessions are failing due to an error while running ansible playbook. How can I run my ansible outside the management plane?</p> <p>A: You can start an <code>ephemeral session</code>, ephemeral sessions tries to replicate the host targeting the ansible playbook started by the session. To start an ephemeral environment run the following command</p> <pre><code>$ manta apply ephemeral-environment --image-id 4bf91021-8d99-4adf-945f-46de2ff50a3d\n1eff1535-c13c-4d21-ba3f-0c852abd713b.ims.cmn.alps.cscs.ch\n</code></pre> <p>Note: the <code>&lt;image id&gt;</code> should be the same base image used by the session</p> <p>The command will return a hostname (<code>1eff1535-c13c-4d21-ba3f-0c852abd713b.ims.cmn.alps.cscs.ch</code>) based on the image id provided, after this, wait a few minutes for the environment to be ready and then create an ansible inventory with this hostname. With this, you should be able to run your ansible scripts locally if you need to troubleshoot your playbook.</p> <p>To test the ephemeral environment</p> <pre><code>$ ssh root@1eff1535-c13c-4d21-ba3f-0c852abd713b.ims.cmn.alps.cscs.ch\nThe authenticity of host '1eff1535-c13c-4d21-ba3f-0c852abd713b.ims.cmn.alps.cscs.ch (148.187.109.148)' can't be established.\nED25519 key fingerprint is SHA256:/np4nEZWYztGbG/6cDI6vTsLU/9uWEXZQ9Msd/DJGNY.\nThis key is not known by any other names\nAre you sure you want to continue connecting (yes/no/[fingerprint])? yes\nWarning: Permanently added '1eff1535-c13c-4d21-ba3f-0c852abd713b.ims.cmn.alps.cscs.ch' (ED25519) to the list of known hosts.\nHave a lot of fun...\ncray-ims-1eff1535-c13c-4d21-ba3f-0c852abd713b-customize-xxl7f:/root #\n</code></pre> <p>Q: How can I add a new site to manta?</p> <p>A: Each site needs to be included in your configuration file under the <code>sites</code> section. Please get in contact with an Alps administrator to help you configuring a new site since manta needs to know the APIs to talk to.</p> <p>Q: How can I list the number of sites <code>site</code> I have available?</p> <p>A: To check all sites available, please run the command below.</p> <pre><code>manta config show\n</code></pre> <p>Q: How can I tell manta to switch from one <code>site</code> to another?</p> <p>A: To tell manta to talk to <code>site name</code> please run the command below.</p> <pre><code>manta config set site &lt;site name&gt;\n</code></pre> <p>Q: What is the easiest way to configure my cluster (build an image, assign image to nodes to boot nodes and configure nodes during runtime) with manta?</p> <p>A: The easiest way to deploy a cluster using manta is through a SAT a template and SAT vars files.</p> <pre><code>$ ls my_cluster_sat\ntemplate.yaml session_vars.yaml\n</code></pre> <p>To tell manta to use those files run the following command:</p> <pre><code>$ manta apply sat --sat-template-file my_cluster_sat/template.yaml --values-file my_cluster_sat/session_vars.yaml\n</code></pre> <p>Q: How to move nodes from cluster <code>A</code> to cluster <code>B</code>?</p> <p>A: To move nodes <code>form nodes_free</code> to <code>my_cluster</code> run the command below</p> <pre><code>$ manta add nodes --target-cluster my_cluster --parent-cluster nodes_free --no-dryrun x1003c1s7b0n0,x1003c1s7b0n1,x1003c1s7b1n0\n</code></pre> <p>Q: How to apply changes during runtime without generating an image?</p> <p>A: To apply changes to a cluster during runtime, run the command below</p> <pre><code>$ manta set runtime-configuration -H my_cluster -c my_configuration\n</code></pre> <p>Q: How can I list all configurations available in the system?</p> <p>A: The simplest command to get all configurations available to a user is <code>manta get configurations</code>. If the user has system wide access, then this command will return all configurations in the system, otherwise, it will return only the configurations used by the cluster(s) the user has access to.</p> <p>Q: How can I filter configurations by cluster name and configuration name?</p> <p>A: <code>manta get configurations -H my_cluster --name my_configuration</code></p> <p>Q:  How can I list the most recent configuration?</p> <p>A: <code>manta get configurations --most-recent</code></p> <p>Q: How can I get details of all configuration layers for the most recent configuration?</p> <p>A: <code>manta get configurations --most-recent</code></p> <p>Note: manta will automatically return configuration layer details when the <code>manta get configurations</code> command returns only 1 configuration</p> <p>Q: How to list all sessions in the system?</p> <p>A: <code>manta get sessions</code></p> <p>Q: How to get the logs of a specific session?</p> <p>A: <code>manta logs my_session</code></p> <p>Q: How to connect to the console of a node?</p> <p>A: <code>manta console node x1003c1s7b0n0</code></p> <p>Q: How to power on/off or reset a node?</p> <p>A: <code>manta power on node x1003c1s7b0n0</code></p> <p>Q: How to list the hardware components of a cluster?</p> <p>A: <code>manta get hardware cluster my_cluster</code></p> <p>Q: How to apply changes during runtime without generating an image?</p> <p>A: </p> <p><code>manta set runtime-configuration</code> command won't reboot nodes</p> <p>Q: How to set kernel parameters for a cluster?</p> <p>A: </p> <p><code>manta set kernel -H my_cluster -k \"ip=dhcp quiet ksocklnd.skip_mr_route_setup=1 cxi_core.disable_default_svc=0 cxi_core.enable_fgfc=1 cxi_core.sct_pid_mask=0xf spire_join_token=${SPIRE_JOIN_TOKEN}\"</code></p> <p>!!!+ info \"No rootfs\"       Do not add the nay parameter related to the <code>root filesystem</code> Alps compute nodes are diskless and the root filesystem is automatically configured when boot image is set</p> <p>Q: How to update node boot images?</p> <p>A: </p> <p>To update the boot image based on a configuration name (recomended) for all the nodes in a cluster <code>manta set boot-image -H my_cluster -c my_configuration_name</code> To update the boot image based on an image id for all the nodes in a cluster <code>manta set boot-image -H my_cluster -i dbc5300c-3c98-4384-a7a7-28e628cbff43</code></p> <p>Q: How to refresh the user authentication token?</p> <p>A: </p> <ol> <li>Delete the auth token for the intended system/site <code>manta config unset auth</code></li> <li>Check manta is using the right site <code>manta config show</code>. This command should ask user to authenticate again since the auth token was deleted in the previous command</li> </ol> <p>Q: error: failed to load manifest for dependency <code>mesa</code></p> <p>A: </p> <p>This is caused because cargo tries to access mesa library code from local filesystem instead of crates.io repository. To fix this, make sure mesa dependency in Cargo.toml looks as below:</p> <pre><code>...\n\n[dependencies]\n# mesa = \"0.37.7\"\nmesa = { path = \"../mesa\" } # Only for development purposes\n\n...\n</code></pre>"},{"location":"installation/","title":"Download and install","text":"<p>To install manta, go to the Github releases section and download the <code>manta-installer.sh</code> script for the most recent version:</p> <pre><code>curl --proto '=https' --tlsv1.2 -LsSf https://github.com/eth-cscs/manta/releases/download/v1.37.0/manta-installer.sh | sh\n</code></pre> <p>If you try to run manta, you should get an error because the configuration file is missing.</p> <pre><code>$ manta --help\nError processing config.toml file. Reason:\nconfiguration file \"/home/msopena/.config/manta/config.toml\" not found\n</code></pre> <p>So far so good, please proceed to the next section (Configuration) to create the manta configuration file</p>"},{"location":"security/","title":"Security","text":"WIP <p>This is work in progress</p> <p>Manta validates the users command against the information in their JWT authentication token.</p> <p>If the user tries to submit an operation against a cluster or node that does not have access, then the operation will fail.</p> <p>Discuss about how manta uses the JWT auth token to restrict user actions</p> <p>Alps system management APIs are not publicly available, manta needs to run from a hardened environment within CSCS</p>"}]}